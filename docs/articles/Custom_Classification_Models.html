<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Applying HISEA estimators to custom classification models with run_hisea_estimates â€¢ RHISEA</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Applying HISEA estimators to custom classification models with run_hisea_estimates">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RHISEA</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Custom_Classification_Models.html">Applying HISEA estimators to custom classification models with run_hisea_estimates</a></li>
    <li><a class="dropdown-item" href="../articles/Multiple_Classifiers.html">Comparing built-in classification methods in RHISEA for mixed-stock analysis</a></li>
    <li><a class="dropdown-item" href="../articles/RHISEA_data_type.html">Two input paths in RHISEA: run_hisea_all with HISEA-style files or Dataframes</a></li>
    <li><a class="dropdown-item" href="../articles/RHISEA_vs_Fortran.html">Verifying compatibility: RHISEA (R) vs FORTRAN HISEA</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="nav-link" href="https://github.com/SostheneA/RHISEA" aria-label="GitHub repository"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Applying HISEA estimators to custom classification models with run_hisea_estimates</h1>
                        <h4 data-toc-skip class="author">Sosthene
Akia</h4>
            <address class="author_afil">
      Fisheries and Oceans
Canada<br><a class="author_email" href="mailto:#"></a><a href="mailto:sosthene.akia@dfo-mpo.ca" class="email">sosthene.akia@dfo-mpo.ca</a>
      </address>
                              <h4 data-toc-skip class="author">Alex
Hanke</h4>
            <address class="author_afil">
      Fisheries and Oceans
Canada<br><a class="author_email" href="mailto:#"></a><a href="mailto:alex.hanke@dfo-mpo.ca" class="email">alex.hanke@dfo-mpo.ca</a>
      </address>
                  
            <h4 data-toc-skip class="date">2025-08-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/SostheneA/RHISEA/blob/HEAD/vignettes/Custom_Classification_Models.Rmd"><code>vignettes/Custom_Classification_Models.Rmd</code></a></small>
      <div class="d-none name"><code>Custom_Classification_Models.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code><a href="../reference/run_hisea_estimates.html">run_hisea_estimates()</a></code> function is a core component
of the <strong>RHISEA</strong> package that allows users to
<strong>build their own classification models</strong> and seamlessly
integrate these results into the classical mixed-stock analysis
framework originally implemented by the HISEA program.</p>
<p>HISEA is widely used to estimate the proportions of different source
populations (stocks) within a mixed sample based on known baseline data.
It does so by combining classification outputs with sophisticated
estimators and bootstrap procedures to provide robust stock composition
estimates along with measures of uncertainty.</p>
<div class="section level3">
<h3 id="purpose-of-run_hisea_estimates">Purpose of <code>run_hisea_estimates()</code><a class="anchor" aria-label="anchor" href="#purpose-of-run_hisea_estimates"></a>
</h3>
<p>This function facilitates the application of <strong>any
classification algorithm</strong> that outputs:</p>
<ul>
<li>
<strong>Pseudo-class assignments</strong> for each mixture sample
(i.e., predicted class labels),</li>
<li>
<strong>Class likelihoods or posterior probabilities</strong> for
each mixture sample (probability of belonging to each stock),</li>
<li>The <strong>confusion matrix or phi matrix</strong> derived from
cross-validation on the baseline data, representing classification
accuracy and error rates.</li>
</ul>
<p>By accepting these key inputs, <code><a href="../reference/run_hisea_estimates.html">run_hisea_estimates()</a></code>
replicates the five classical HISEA estimators:</p>
<p>From Raw estimator (based directly on pseudo-classes) to ML
estimator.</p>
<p>This allows users to <strong>combine modern or custom classifiers
with the trusted HISEA estimation framework</strong>, obtaining stock
proportion estimates and associated confidence measures that are
directly comparable to the original HISEA output.</p>
</div>
<div class="section level3">
<h3 id="what-you-need-to-provide">What you need to provide<a class="anchor" aria-label="anchor" href="#what-you-need-to-provide"></a>
</h3>
<p>To use <code><a href="../reference/run_hisea_estimates.html">run_hisea_estimates()</a></code>, you need to supply the
following:</p>
<ul>
<li>
<code>pseudo_classes</code>: An integer vector of predicted classes
(one per mixture individual), as produced by your classifier.</li>
<li>
<code>likelihoods</code>: A numeric matrix of posterior
probabilities or class likelihoods for each mixture individual across
all stocks (columns correspond to stocks).</li>
<li>
<code>phi_matrix</code>: The phi matrix (classification error
matrix) computed from cross-validation on your baseline data. This
matrix captures how often each stock is classified as each other stock,
accounting for misclassification rates.</li>
<li>
<code>np</code>: Number of populations or stocks in your baseline
data.</li>
<li>
<code>stocks_names</code>: Character vector naming each stock in
order.</li>
<li>
<code>type</code>: Estimation type, typically
<code>"BOOTSTRAP"</code> for bootstrap confidence intervals or
<code>"ANALYSIS"</code>.</li>
<li>Additional arguments for output control, such as
<code>export_csv</code> and <code>output_dir</code>.</li>
</ul>
</div>
<div class="section level3">
<h3 id="how-it-works-internally">How it works internally<a class="anchor" aria-label="anchor" href="#how-it-works-internally"></a>
</h3>
<p>The function uses the provided pseudo-classes and likelihoods as
inputs to the five estimators implemented in HISEA, incorporating the
phi matrix to adjust for classification uncertainty and errors. It runs
bootstrap replicates to compute confidence intervals and standard
deviations for the estimated stock proportions, enabling statistically
sound inference.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="linear-discriminant-analysis-lda">1. Linear Discriminant Analysis (LDA)<a class="anchor" aria-label="anchor" href="#linear-discriminant-analysis-lda"></a>
</h2>
<p>We start with a classical parametric classifier, LDA, to illustrate
the workflow.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/" class="external-link">caret</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/reshape" class="external-link">reshape2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/SostheneA/RHISEA">RHISEA</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load baseline and mixture data</span></span>
<span><span class="va">baseline_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"baseline.rda"</span>, package <span class="op">=</span> <span class="st">"RHISEA"</span><span class="op">)</span></span>
<span><span class="va">mixture_file</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"mixture.rda"</span>,  package <span class="op">=</span> <span class="st">"RHISEA"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="va">baseline_file</span><span class="op">)</span>  <span class="co"># loads `baseline` data.frame</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="va">mixture_file</span><span class="op">)</span>   <span class="co"># loads `mixture` data.frame</span></span>
<span></span>
<span><span class="co"># Prepare baseline data</span></span>
<span><span class="va">baseline</span><span class="op">$</span><span class="va">population</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">baseline</span><span class="op">$</span><span class="va">population</span><span class="op">)</span></span>
<span><span class="va">stocks_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">baseline</span><span class="op">$</span><span class="va">population</span><span class="op">)</span></span>
<span><span class="va">np</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">stocks_names</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define formula for classification</span></span>
<span><span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">population</span> <span class="op">~</span> <span class="va">d13c</span> <span class="op">+</span> <span class="va">d18o</span></span>
<span></span>
<span><span class="co"># Function to perform stratified k-fold CV and compute phi matrix for LDA</span></span>
<span><span class="va">get_cv_results_lda</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">formula</span>, <span class="va">k</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>  <span class="va">folds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/createDataPartition.html" class="external-link">createFolds</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">population</span>, k <span class="op">=</span> <span class="va">k</span>, list <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">all_predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">population</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">all_probabilities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">population</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                              dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">population</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">folds</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">test_idx</span> <span class="op">&lt;-</span> <span class="va">folds</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">train_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">test_idx</span>, <span class="op">]</span></span>
<span>    <span class="va">test_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">test_idx</span>, <span class="op">]</span></span>
<span>    </span>
<span>    <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lda.html" class="external-link">lda</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span></span>
<span>    <span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span><span class="op">)</span></span>
<span>    <span class="va">all_predictions</span><span class="op">[</span><span class="va">test_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred</span><span class="op">$</span><span class="va">class</span></span>
<span>    <span class="va">all_probabilities</span><span class="op">[</span><span class="va">test_idx</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred</span><span class="op">$</span><span class="va">posterior</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">conf_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span>Predicted <span class="op">=</span> <span class="va">all_predictions</span>, Actual <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">population</span><span class="op">)</span></span>
<span>  <span class="va">phi_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proportions.html" class="external-link">prop.table</a></span><span class="op">(</span><span class="va">conf_matrix</span>, margin <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>confusion_matrix <span class="op">=</span> <span class="va">conf_matrix</span>,</span>
<span>       phi_matrix <span class="op">=</span> <span class="va">phi_matrix</span>,</span>
<span>       predictions <span class="op">=</span> <span class="va">all_predictions</span>,</span>
<span>       probabilities <span class="op">=</span> <span class="va">all_probabilities</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run CV and get phi matrix</span></span>
<span><span class="va">lda_cv</span> <span class="op">&lt;-</span> <span class="fu">get_cv_results_lda</span><span class="op">(</span><span class="va">baseline</span>, <span class="va">formula</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Train full LDA model on baseline</span></span>
<span><span class="va">lda_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/lda.html" class="external-link">lda</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">baseline</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prepare mixture data for prediction</span></span>
<span><span class="va">mix_data_prepared</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  d13c <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">mixture</span><span class="op">$</span><span class="va">d13c_ukn</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  d18o <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">mixture</span><span class="op">$</span><span class="va">d18o_ukn</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Predict classes and posterior probabilities for mixture</span></span>
<span><span class="va">lda_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">lda_model</span>, <span class="va">mix_data_prepared</span><span class="op">)</span></span>
<span><span class="va">lda_classes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">lda_pred</span><span class="op">$</span><span class="va">class</span><span class="op">)</span></span>
<span><span class="va">lda_probs</span> <span class="op">&lt;-</span> <span class="va">lda_pred</span><span class="op">$</span><span class="va">posterior</span></span>
<span></span>
<span><span class="co"># Convert phi matrix to numeric matrix if needed</span></span>
<span><span class="va">phi_matrix_numeric</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">lda_cv</span><span class="op">$</span><span class="va">phi_matrix</span><span class="op">)</span></span>
<span><span class="va">phi_matrix_numeric</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">phi_matrix_numeric</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">phi_matrix_numeric</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">phi_matrix_numeric</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run HISEA estimates with LDA results</span></span>
<span><span class="va">lda_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_hisea_estimates.html">run_hisea_estimates</a></span><span class="op">(</span></span>
<span>  pseudo_classes <span class="op">=</span> <span class="va">lda_classes</span>,</span>
<span>  likelihoods <span class="op">=</span> <span class="va">lda_probs</span>,</span>
<span>  phi_matrix <span class="op">=</span> <span class="va">phi_matrix_numeric</span>,</span>
<span>  np <span class="op">=</span> <span class="va">np</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"BOOTSTRAP"</span>,</span>
<span>  stocks_names <span class="op">=</span> <span class="va">stocks_names</span>,</span>
<span>  export_csv <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"results_lda"</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nLDA Results - Mean Estimates:\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## LDA Results - Mean Estimates:</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">lda_results</span><span class="op">$</span><span class="va">mean_estimates</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            RAW      COOK     COOKC        EM        ML</span></span>
<span><span class="co">## East 0.3774489 0.3405903 0.3405903 0.3405905 0.3221202</span></span>
<span><span class="co">## West 0.6225511 0.6594097 0.6594097 0.6594095 0.6778798</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nLDA Results - Standard Deviations:\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## LDA Results - Standard Deviations:</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">lda_results</span><span class="op">$</span><span class="va">sd_estimates</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              RAW        COOK       COOKC          EM          ML</span></span>
<span><span class="co">## East 0.007156959 0.008194992 0.008194992 0.008194945 0.008626433</span></span>
<span><span class="co">## West 0.007156959 0.008194992 0.008194992 0.008194945 0.008626433</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualization of results</span></span>
<span><span class="va">results_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">lda_results</span><span class="op">$</span><span class="va">mean_estimates</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">results_long</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Stock"</span>, <span class="st">"Method"</span>, <span class="st">"Proportion"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">results_long</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Method</span>, y <span class="op">=</span> <span class="va">Proportion</span>, fill <span class="op">=</span> <span class="va">Stock</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>, position <span class="op">=</span> <span class="st">"dodge"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"LDA Stock Proportion Estimates"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Estimated Proportion"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Estimation Method"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Custom_Classification_Models_files/figure-html/lda-1.png" alt="LDA classification results for mixed stock analysis" width="700"></p>
<hr>
</div>
<div class="section level2">
<h2 id="random-forest-rf">2. Random Forest (RF)<a class="anchor" aria-label="anchor" href="#random-forest-rf"></a>
</h2>
<p>Next, we apply Random Forest, a powerful ensemble learning
method.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/" class="external-link">randomForest</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Function to perform stratified k-fold CV and compute phi matrix for RF</span></span>
<span><span class="va">get_cv_results_rf</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">formula</span>, <span class="va">k</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">ntree</span> <span class="op">=</span> <span class="fl">500</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>  <span class="va">folds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/createDataPartition.html" class="external-link">createFolds</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">population</span>, k <span class="op">=</span> <span class="va">k</span>, list <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">all_predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">population</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">all_probabilities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">population</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                              dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">population</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">folds</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">test_idx</span> <span class="op">&lt;-</span> <span class="va">folds</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">train_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">test_idx</span>, <span class="op">]</span></span>
<span>    <span class="va">test_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">test_idx</span>, <span class="op">]</span></span>
<span>    </span>
<span>    <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html" class="external-link">randomForest</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">train_data</span>, ntree <span class="op">=</span> <span class="va">ntree</span><span class="op">)</span></span>
<span>    <span class="va">all_predictions</span><span class="op">[</span><span class="va">test_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span><span class="op">)</span></span>
<span>    <span class="va">all_probabilities</span><span class="op">[</span><span class="va">test_idx</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">conf_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span>Predicted <span class="op">=</span> <span class="va">all_predictions</span>, Actual <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">population</span><span class="op">)</span></span>
<span>  <span class="va">phi_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proportions.html" class="external-link">prop.table</a></span><span class="op">(</span><span class="va">conf_matrix</span>, margin <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>confusion_matrix <span class="op">=</span> <span class="va">conf_matrix</span>,</span>
<span>       phi_matrix <span class="op">=</span> <span class="va">phi_matrix</span>,</span>
<span>       predictions <span class="op">=</span> <span class="va">all_predictions</span>,</span>
<span>       probabilities <span class="op">=</span> <span class="va">all_probabilities</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run CV and get phi matrix</span></span>
<span><span class="va">rf_cv</span> <span class="op">&lt;-</span> <span class="fu">get_cv_results_rf</span><span class="op">(</span><span class="va">baseline</span>, <span class="va">formula</span>, ntree <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Train full RF model on baseline</span></span>
<span><span class="va">rf_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html" class="external-link">randomForest</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">baseline</span>, ntree <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Predict classes and posterior probabilities for mixture</span></span>
<span><span class="va">rf_probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">rf_model</span>, <span class="va">mix_data_prepared</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span><span class="va">rf_classes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">rf_model</span>, <span class="va">mix_data_prepared</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run HISEA estimates with RF results</span></span>
<span><span class="va">rf_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_hisea_estimates.html">run_hisea_estimates</a></span><span class="op">(</span></span>
<span>  pseudo_classes <span class="op">=</span> <span class="va">rf_classes</span>,</span>
<span>  likelihoods <span class="op">=</span> <span class="va">rf_probs</span>,</span>
<span>  phi_matrix <span class="op">=</span> <span class="va">rf_cv</span><span class="op">$</span><span class="va">phi_matrix</span>,</span>
<span>  np <span class="op">=</span> <span class="va">np</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"BOOTSTRAP"</span>,</span>
<span>  stocks_names <span class="op">=</span> <span class="va">stocks_names</span>,</span>
<span>  export_csv <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"results_rf"</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nRandom Forest Results - Mean Estimates:\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Random Forest Results - Mean Estimates:</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">rf_results</span><span class="op">$</span><span class="va">mean_estimates</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            RAW      COOK     COOKC        EM        ML</span></span>
<span><span class="co">## East 0.3783069 0.3794679 0.3794679 0.3794679 0.3518484</span></span>
<span><span class="co">## West 0.6216931 0.6205321 0.6205321 0.6205321 0.6481516</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nRandom Forest Results - Standard Deviations:\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Random Forest Results - Standard Deviations:</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">rf_results</span><span class="op">$</span><span class="va">sd_estimates</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              RAW        COOK       COOKC          EM          ML</span></span>
<span><span class="co">## East 0.007135641 0.007700332 0.007700332 0.007700327 0.008733984</span></span>
<span><span class="co">## West 0.007135641 0.007700332 0.007700332 0.007700327 0.008733984</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualization of results</span></span>
<span><span class="va">results_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">rf_results</span><span class="op">$</span><span class="va">mean_estimates</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">results_long</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Stock"</span>, <span class="st">"Method"</span>, <span class="st">"Proportion"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">results_long</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Method</span>, y <span class="op">=</span> <span class="va">Proportion</span>, fill <span class="op">=</span> <span class="va">Stock</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>, position <span class="op">=</span> <span class="st">"dodge"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Random Forest Stock Proportion Estimates"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Estimated Proportion"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Estimation Method"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Custom_Classification_Models_files/figure-html/rf-1.png" alt="Random Forest classification results for mixed stock analysis" width="700"></p>
<hr>
</div>
<div class="section level2">
<h2 id="conditional-inference-tree-ctree">3. Conditional Inference Tree (CTREE)<a class="anchor" aria-label="anchor" href="#conditional-inference-tree-ctree"></a>
</h2>
<p>Finally, we demonstrate a non-parametric tree method based on
permutation tests.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://party.R-forge.R-project.org" class="external-link">party</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Function to perform stratified k-fold CV and compute phi matrix for CTREE</span></span>
<span><span class="va">get_cv_results_ctree</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">formula</span>, <span class="va">k</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>  <span class="va">folds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/createDataPartition.html" class="external-link">createFolds</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">population</span>, k <span class="op">=</span> <span class="va">k</span>, list <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">all_predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">population</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">all_probabilities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">population</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                              dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">population</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">folds</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">test_idx</span> <span class="op">&lt;-</span> <span class="va">folds</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">train_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">test_idx</span>, <span class="op">]</span></span>
<span>    <span class="va">test_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">test_idx</span>, <span class="op">]</span></span>
<span>    </span>
<span>    <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/party/man/ctree.html" class="external-link">ctree</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span></span>
<span>    <span class="va">pred_probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span>    <span class="va">pred_probs_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">pred_probs</span><span class="op">)</span></span>
<span>    <span class="va">all_predictions</span><span class="op">[</span><span class="va">test_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">test_data</span><span class="op">)</span></span>
<span>    <span class="va">all_probabilities</span><span class="op">[</span><span class="va">test_idx</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pred_probs_matrix</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">conf_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span>Predicted <span class="op">=</span> <span class="va">all_predictions</span>, Actual <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">population</span><span class="op">)</span></span>
<span>  <span class="va">phi_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proportions.html" class="external-link">prop.table</a></span><span class="op">(</span><span class="va">conf_matrix</span>, margin <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>confusion_matrix <span class="op">=</span> <span class="va">conf_matrix</span>,</span>
<span>       phi_matrix <span class="op">=</span> <span class="va">phi_matrix</span>,</span>
<span>       predictions <span class="op">=</span> <span class="va">all_predictions</span>,</span>
<span>       probabilities <span class="op">=</span> <span class="va">all_probabilities</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run CV and get phi matrix</span></span>
<span><span class="va">ctree_cv</span> <span class="op">&lt;-</span> <span class="fu">get_cv_results_ctree</span><span class="op">(</span><span class="va">baseline</span>, <span class="va">formula</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Train full CTREE model on baseline</span></span>
<span><span class="va">ctree_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/party/man/ctree.html" class="external-link">ctree</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">baseline</span>,</span>
<span>                     controls <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/party/man/ctree_control.html" class="external-link">ctree_control</a></span><span class="op">(</span>mincriterion <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>                                              minsplit <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                                              minbucket <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Predict classes and posterior probabilities for mixture</span></span>
<span><span class="va">ctree_probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">ctree_model</span>, <span class="va">mix_data_prepared</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span><span class="va">ctree_probs_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">ctree_probs</span><span class="op">)</span></span>
<span><span class="va">ctree_classes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">ctree_model</span>, <span class="va">mix_data_prepared</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run HISEA estimates with CTREE results</span></span>
<span><span class="va">ctree_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_hisea_estimates.html">run_hisea_estimates</a></span><span class="op">(</span></span>
<span>  pseudo_classes <span class="op">=</span> <span class="va">ctree_classes</span>,</span>
<span>  likelihoods <span class="op">=</span> <span class="va">ctree_probs_matrix</span>,</span>
<span>  phi_matrix <span class="op">=</span> <span class="va">ctree_cv</span><span class="op">$</span><span class="va">phi_matrix</span>,</span>
<span>  np <span class="op">=</span> <span class="va">np</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"BOOTSTRAP"</span>,</span>
<span>  stocks_names <span class="op">=</span> <span class="va">stocks_names</span>,</span>
<span>  export_csv <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"results_ctree"</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nCTREE Results - Mean Estimates:\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## CTREE Results - Mean Estimates:</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ctree_results</span><span class="op">$</span><span class="va">mean_estimates</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            RAW      COOK     COOKC        EM        ML</span></span>
<span><span class="co">## East 0.4027002 0.3894321 0.3894321 0.3894321 0.3295694</span></span>
<span><span class="co">## West 0.5972998 0.6105679 0.6105679 0.6105679 0.6704306</span></span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nCTREE Results - Standard Deviations:\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## CTREE Results - Standard Deviations:</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ctree_results</span><span class="op">$</span><span class="va">sd_estimates</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            RAW        COOK       COOKC          EM          ML</span></span>
<span><span class="co">## East 0.0073643 0.008368522 0.008368522 0.008368519 0.008819052</span></span>
<span><span class="co">## West 0.0073643 0.008368522 0.008368522 0.008368519 0.008819052</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualize tree and results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ctree_model</span><span class="op">)</span></span></code></pre></div>
<p><img src="Custom_Classification_Models_files/figure-html/ctree-1.png" alt="CTREE classification results for mixed stock analysis" width="700"></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">ctree_results</span><span class="op">$</span><span class="va">mean_estimates</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">results_long</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Stock"</span>, <span class="st">"Method"</span>, <span class="st">"Proportion"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">results_long</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Method</span>, y <span class="op">=</span> <span class="va">Proportion</span>, fill <span class="op">=</span> <span class="va">Stock</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>, position <span class="op">=</span> <span class="st">"dodge"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"CTREE Stock Proportion Estimates"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Estimated Proportion"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Estimation Method"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Custom_Classification_Models_files/figure-html/ctree-2.png" alt="CTREE classification results for mixed stock analysis" width="700"></p>
<hr>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>This vignette demonstrated how to:</p>
<ul>
<li>Prepare baseline and mixture data,</li>
<li>Perform stratified cross-validation to estimate classification
accuracy (phi matrix),</li>
<li>Train various classifiers (LDA, RF, CTREE),</li>
<li>Predict mixture sample classes and posterior probabilities,</li>
<li>Run <code><a href="../reference/run_hisea_estimates.html">run_hisea_estimates()</a></code> to get robust mixed-stock
proportion estimates with confidence intervals,</li>
<li>Visualize and interpret the results.</li>
</ul>
<p>You can extend this approach to any classification method that
provides pseudo-classes and posterior probabilities, leveraging the
classical HISEA framework within the <strong>RHISEA</strong>
package.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sosthene Akia, Alex Hanke.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
